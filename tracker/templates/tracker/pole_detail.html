{% extends 'tracker/base.html' %}
{% load tracker_extras %}

{% block content %}
<div class="container py-4">
    
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="fw-bold text-dark">{{ pole.project.name }}</h2>
            <h4 class="text-muted">Pole: {{ pole.identifier }}</h4>
            
            {% if pole.is_completed %}
                <div class="alert alert-success mt-3 fw-bold">
                    ‚úÖ All Stages Completed!
                </div>
            {% else %}
                <div class="progress mt-3" style="height: 25px;">
                    <div class="progress-bar bg-warning text-dark" role="progressbar" 
                         style="width: {{ pole.progress_percent }}%">
                         In Progress
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <h3 class="mb-3">Construction Stages</h3>

    <div class="row">
        {% for stage in stages %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm {% if stage.id in evidence_map %}border-success{% endif %}">
                    
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">{{ stage.name }}</span>
                        <span class="badge bg-secondary">Step {{ stage.order }}</span>
                    </div>

                    <div class="card-body">
                        
                        {% if stage.id in evidence_map %}
                            {% with evidence=evidence_map|get_item:stage.id %}
                                <div class="text-center mb-3">
                                    <img src="{{ evidence.image.url }}" class="img-fluid rounded border" alt="Proof">
                                </div>
                                <div class="d-grid">
                                    <a href="{% url 'delete_evidence' evidence.id %}" 
                                       class="btn btn-outline-danger btn-sm"
                                       onclick="return confirm('Delete this photo? You will need to upload a new one.');">
                                        üóë Delete & Replace
                                    </a>
                                </div>
                            {% endwith %}

                        {% else %}
                            <div class="text-center py-3 bg-light rounded mb-3">
                                <span class="text-muted">No photo yet</span>
                            </div>

                            <button type="button" class="btn btn-primary w-100" 
                                    onclick="openCamera('{{ stage.id }}', '{{ stage.name }}')">
                                üì∑ Upload Photo
                            </button>
                        {% endif %}

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>


<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Upload for: <span id="modalStageName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="modal-body">
                    
                    <input type="hidden" name="stage_id" id="inputStageId">
                    
                    <input type="hidden" name="gps_lat" id="lat">
                    <input type="hidden" name="gps_long" id="lon">

                    <div class="mb-3 text-center">
                        <label class="form-label fw-bold">Select Photo</label>
                        
                        <input type="file" name="image" class="form-control" accept="image/*" capture="environment" required>
                        
                        <div class="form-text">Location will be stamped automatically.</div>
                    </div>

                    <div id="locationStatus" class="alert alert-info py-1 small">
                        Getting GPS location...
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success w-100" id="submitBtn">
                        Confirm Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    // OPEN CAMERA
    function openCamera(stageId, stageName) {
        document.getElementById('inputStageId').value = stageId;
        document.getElementById('modalStageName').innerText = stageName;
        
        // --- CHANGE 1: DO NOT DISABLE THE BUTTON ---
        // We want to allow immediate upload so we can use EXIF data.
        document.getElementById("submitBtn").disabled = false; 
        
        document.getElementById("locationStatus").innerText = "Ready to upload. (Will check photo for GPS)";
        document.getElementById("locationStatus").className = "alert alert-secondary py-1 small";

        var myModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        myModal.show();

        // We still try to get browser GPS in the background as a backup,
        // but we don't wait for it.
        getLocation();
    }

    // GET LOCATION (Background Process)
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError, {timeout: 5000});
        }
    }

    function showPosition(position) {
        // If browser GPS is found fast enough, we use it!
        document.getElementById("lat").value = position.coords.latitude.toFixed(6);
        document.getElementById("lon").value = position.coords.longitude.toFixed(6);
        
        var status = document.getElementById("locationStatus");
        status.className = "alert alert-success py-1 small";
        status.innerHTML = "üìç Browser GPS Locked! (Optional)";
    }

    function showError(error) {
        console.log("Browser GPS failed (using Photo EXIF instead)");
        // Do nothing to the UI, just let the user upload.
    }
</script>



{% endblock %}